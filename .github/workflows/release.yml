name: Auto Release

on:
  push:
    branches: [ "**" ]  # Changed from [ main ] to work on any branch
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: read

env:
  GO_VERSION: '1.21'

jobs:
  version:
    name: Determine Next Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get latest tag
      id: latest_tag
      run: |
        # Get the latest tag, default to v0.0.0 if no tags exist
        latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
        echo "Latest tag: $latest_tag"

    - name: Determine version bump
      id: bump_type
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "bump_type=${{ github.event.inputs.version_bump }}" >> $GITHUB_OUTPUT
        else
          # Auto-determine based on commit messages
          commits=$(git log ${{ steps.latest_tag.outputs.latest_tag }}..HEAD --oneline)
          echo "Commits since last tag:"
          echo "$commits"
          
          if echo "$commits" | grep -q "BREAKING CHANGE\|!:"; then
            echo "bump_type=major" >> $GITHUB_OUTPUT
          elif echo "$commits" | grep -q "feat:"; then
            echo "bump_type=minor" >> $GITHUB_OUTPUT
          else
            echo "bump_type=patch" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Calculate next version
      id: version
      run: |
        latest_tag="${{ steps.latest_tag.outputs.latest_tag }}"
        bump_type="${{ steps.bump_type.outputs.bump_type }}"
        
        # Remove 'v' prefix if present
        version=${latest_tag#v}
        
        # Split version into parts
        IFS='.' read -r major minor patch <<< "$version"
        
        # Increment based on bump type
        case $bump_type in
          major)
            major=$((major + 1))
            minor=0
            patch=0
            ;;
          minor)
            minor=$((minor + 1))
            patch=0
            ;;
          patch)
            patch=$((patch + 1))
            ;;
        esac
        
        new_version="$major.$minor.$patch"
        new_tag="v$new_version"
        
        echo "version=$new_version" >> $GITHUB_OUTPUT
        echo "tag=$new_tag" >> $GITHUB_OUTPUT
        echo "Next version: $new_version"
        echo "Next tag: $new_tag"

    - name: Create and push tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        tag="${{ steps.version.outputs.tag }}"
        git tag -a "$tag" -m "Release $tag"
        git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git "$tag"
        echo "Created and pushed tag: $tag"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    needs: version
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux builds
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            cgo_enabled: 1
            static: true
          - os: linux
            arch: arm64
            runner: ubuntu-latest
            cgo_enabled: 1
            static: true
          # macOS builds
          - os: darwin
            arch: amd64
            runner: macos-13  # Intel runner for x86_64 builds
            cgo_enabled: 1
            static: false
          - os: darwin
            arch: arm64
            runner: macos-latest  # ARM64 runner for arm64 builds
            cgo_enabled: 1
            static: false
          # Windows builds (CGO disabled due to complexity)
          - os: windows
            arch: amd64
            runner: windows-latest
            cgo_enabled: 0
            static: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y librtlsdr-dev pkg-config gcc-aarch64-linux-gnu
        
    - name: Install dependencies (macOS)
      if: matrix.os == 'darwin'
      run: |
        brew install librtlsdr pkg-config
        
        # Set up environment for cross-compilation
        echo "PKG_CONFIG_PATH=$(brew --prefix librtlsdr)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Set up build environment
      run: |
        echo "GOOS=${{ matrix.os }}" >> $GITHUB_ENV
        echo "GOARCH=${{ matrix.arch }}" >> $GITHUB_ENV
        echo "CGO_ENABLED=${{ matrix.cgo_enabled }}" >> $GITHUB_ENV

    - name: Set up cross-compilation (Linux ARM64)
      if: matrix.os == 'linux' && matrix.arch == 'arm64'
      run: |
        echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig" >> $GITHUB_ENV

    - name: Build binary
      run: |
        mkdir -p dist
        version="${{ needs.version.outputs.version }}"
        
        # Debug: Print build environment
        echo "Building for GOOS=$GOOS GOARCH=$GOARCH CGO_ENABLED=$CGO_ENABLED"
        go env
        
        if [ "${{ matrix.cgo_enabled }}" = "1" ]; then
          if [ "${{ matrix.static }}" = "true" ]; then
            # Static build for Linux - fix the linking issue
            go build -ldflags "-linkmode external -extldflags '-static -lusb-1.0' -X main.Version=$version" -o dist/go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }} .
          else
            # Dynamic build for macOS and other platforms
            go build -ldflags "-X main.Version=$version" -o dist/go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }} .
          fi
        else
          # No CGO build for Windows
          go build -ldflags "-X main.Version=$version" -o dist/go1090-${{ matrix.os }}-${{ matrix.arch }}.exe .
        fi

    - name: Create release package
      run: |
        cd dist
        binary_name="go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}"
        package_name="go1090-${{ needs.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}"
        
        mkdir -p "$package_name"
        cp "$binary_name" "$package_name/"
        cp ../README.md "$package_name/"
        cp ../LICENSE "$package_name/"
        cp ../CHANGELOG.md "$package_name/"
        
        # Create platform-specific README
        cat > "$package_name/INSTALL.md" << 'EOF'
        # Installation Instructions - ${{ matrix.os }}/${{ matrix.arch }}
        
        ## Quick Start
        
        ```bash
        # Make executable (Linux/macOS only)
        chmod +x go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
        
        # Run with default settings
        ./go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
        ```
        
        ## Dependencies
        
        ${{ matrix.os == 'linux' && '### Linux
        ```bash
        # Ubuntu/Debian
        sudo apt-get install librtlsdr0
        
        # CentOS/RHEL/Fedora
        sudo yum install rtl-sdr
        ```' || '' }}
        
        ${{ matrix.os == 'darwin' && '### macOS
        ```bash
        brew install librtlsdr
        ```' || '' }}
        
        ${{ matrix.os == 'windows' && '### Windows
        **Note**: This Windows build has RTL-SDR support disabled.
        For full functionality, use Linux or macOS builds, or build from source.' || '' }}
        
        ## Usage
        
        ```bash
        # Show help
        ./go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }} --help
        
        # Run with custom settings
        ./go1090-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }} --verbose --log-dir ./logs
        ```
        
        For more information, see README.md
        EOF
        
        # Create ZIP archive
        if [ "${{ matrix.os }}" = "windows" ]; then
          zip -r "${package_name}.zip" "$package_name"
        else
          zip -r "${package_name}.zip" "$package_name"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: go1090-${{ matrix.os }}-${{ matrix.arch }}
        path: dist/go1090-${{ needs.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}.zip

  release:
    name: Create Release
    needs: [version, build]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -la artifacts/

    - name: Generate changelog
      id: changelog
      run: |
        # Get commits since last tag for changelog
        if [ -n "${{ needs.version.outputs.tag }}" ]; then
          previous_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          if [ -n "$previous_tag" ]; then
            echo "## Changes since $previous_tag" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            git log $previous_tag..HEAD --oneline --pretty=format:"- %s" >> RELEASE_NOTES.md
          else
            echo "## Initial Release" > RELEASE_NOTES.md
          fi
        else
          echo "## Release Notes" > RELEASE_NOTES.md
        fi
        
        # Add download section
        cat >> RELEASE_NOTES.md << 'EOF'
        
        ## Downloads
        
        Choose the appropriate ZIP file for your system:
        
        ### Linux
        - **Linux x64**: `go1090-${{ needs.version.outputs.version }}-linux-amd64.zip`
        - **Linux ARM64**: `go1090-${{ needs.version.outputs.version }}-linux-arm64.zip`
        
        ### macOS
        - **macOS Intel**: `go1090-${{ needs.version.outputs.version }}-darwin-amd64.zip`
        - **macOS Apple Silicon**: `go1090-${{ needs.version.outputs.version }}-darwin-arm64.zip`
        
        ### Windows
        - **Windows x64**: `go1090-${{ needs.version.outputs.version }}-windows-amd64.zip`
        - ⚠️ **Note**: Windows build has limited RTL-SDR support
        
        ## Installation
        
        1. Download the appropriate ZIP file for your system
        2. Extract the ZIP file
        3. Follow the INSTALL.md instructions included in the package
        4. Install RTL-SDR dependencies as described
        5. Run the binary
        
        ## Requirements
        
        - RTL2832U USB SDR device
        - librtlsdr library installed (except Windows)
        - 1090MHz antenna (for optimal reception)
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.version.outputs.tag }}
        name: Go1090 ${{ needs.version.outputs.tag }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          artifacts/*/go1090-${{ needs.version.outputs.version }}-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notification:
    name: Send Notification
    needs: [version, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify Success
      if: needs.release.result == 'success'
      run: |
        echo "🎉 Release ${{ needs.version.outputs.tag }} created successfully!"
        echo "Download: https://github.com/${{ github.repository }}/releases/tag/${{ needs.version.outputs.tag }}"
        
    - name: Notify Failure
      if: needs.release.result == 'failure'
      run: |
        echo "❌ Release ${{ needs.version.outputs.tag }} failed!"
        exit 1 